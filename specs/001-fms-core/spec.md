# Feature Specification: 統合火災管理システム (FMS) — Core ワークフロー

**Feature Branch**: `001-fms-core`  
**Created**: 2026-02-09  
**Status**: Draft  
**Input**: User description: "統合火災管理システム (FMS) — 緊急通報から出動、現場到着、鎮火報告までのコアワークフローを完結するMVP"

## Clarifications

### Session 2026-02-09

- Q: マルチテナントのデータ分離方式（スキーマ分離 vs 行レベル制御） → A: Single schema + Row-level Security (RLS)

### Session 2026-02-10

- Q: テナント識別子はどのようにアプリ→DBへ渡すべきか？ → A: JWT クレーム `tenant_id` を推奨。アプリ側で JWT の署名・発行者を検証し、各トランザクション開始前に DB セッション変数を設定して RLS と整合させる（例: `SELECT fms_set_current_tenant('<tenant-uuid>');` または `SET LOCAL fms.current_tenant = '<tenant-uuid>';`）。

- Q: API リクエストボディに `tenant_id` を含めてよいか？ → A: いいえ。テナント識別は JWT クレーム `tenant_id` のみを権威とする。サーバはリクエストボディの `tenant_id` を受け付けないか、存在した場合は JWT と一致しない限り 403 を返す実装とする（推奨はボディを受け付けない）。

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 通報→指令→出動（Priority: P1）

指令員が通報を受け付け、場所を確定して最適な部隊を指令し、隊員が受信して出動ステータスを更新できる一連の流れ。

**Why this priority**: コアワークフローであり、MVPの価値提供の中心であるため最優先。

**Independent Test**: 司令室UIで通報を作成し、車両を選択して指令を出す。モバイル側で指令を受け取りステータスを「出動」「現着」「鎮火」に更新できることを確認する。

**Acceptance Scenarios**:

1. **Given** 新規通報フォームが開いている, **When** 指令員が住所またはピンで場所を指定し「通報作成」を実行, **Then** インシデントが作成され、利用可能な車両の候補リストが表示される。
2. **Given** 指令員が車両を選択して「指令」を発行, **When** 指令が正常に処理される, **Then** 選択車両に指令通知が配信され、司令室のインシデント表示が即時更新される。
3. **Given** 隊員のモバイルが指令を受信, **When** 隊員が「出動」を選択, **Then** 司令室で車両ステータスが「出動(En Route)」に変わる。

---

### User Story 2 - モバイルでのステータス更新とGPS共有（Priority: P2）

隊員がモバイルアプリで指令を受け、出動中に定期的に位置情報を送信し、司令室で地図上に反映される。

**Why this priority**: 指令の実効性と隊員安全のため、動態可視化は必須だがまずは基本的な送受信で十分。

**Independent Test**: モバイルから疑似GPSを送信し、司令室側マップ上でアイコン位置が更新されることを確認する。

**Acceptance Scenarios**:

1. **Given** 隊員が出動中, **When** モバイルが位置情報を送信, **Then** 司令室の地図上の車両位置が数秒以内に更新される。

---

### User Story 3 - 地理空間検索による近接車両候補表示（Priority: P3）

通報場所に対して半径N km内で利用可能な車両を検索し、指令員に候補を提示する機能。

**Why this priority**: 指令支援として重要だが、ベーシックな候補提示でMVPは成立する。

**Independent Test**: テスト用車両データを配置し、通報位置に対して検索を実行して期待した候補が返ることを確認する。

**Acceptance Scenarios**:

1. **Given** 複数車両の初期位置が登録されている, **When** 通報を作成して「近接車両検索」を実行, **Then** 指定距離内で利用可能な車両のみがソートされたリストで表示される。

---

### Edge Cases

- 通報に位置情報が不明（住所のみ）で、ジオコーディングが失敗した場合は指令員が手動でピンを打てること。
- 車両が既に他のインシデントに割り当てられている場合の競合（最初にコミットされた指令を優先）を取り扱うこと。
- モバイルの通信断（オフライン）時はローカルに操作を保持し、再接続で同期されること。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 指令員は新規インシデントを作成できる（場所、火災種別、重要度、備考を入力可能）。
- **FR-002**: システムはインシデント作成後に、指定半径内の「利用可能」な車両候補を提示する検索機能を提供する（検索結果はソート可能）。
- **FR-003**: 指令員は選択した車両へ対して指令を発行できる。指令発行はトランザクションとして扱われ、重複指令や競合を防止すること。
- **FR-004**: モバイル端末は指令受信、ステータス更新（出動/現着/鎮火）および定期的な位置情報送信ができる。
- **FR-005**: 司令室はリアルタイムに車両ステータスと位置情報を反映する（画面のリロード不要で更新されること）。
- **FR-006**: システムはマルチテナント対応であり、テナント間のデータ分離を維持する（Assumptions参照）。
- **FR-007**: 基本的なエラー/競合ケース（ジオコーディング失敗、通信断、指令競合）に対してユーザー向けに明確な回復手順またはメッセージを提示する。

### Key Entities *(include if feature involves data)*

- **Tenant**: 組織単位の識別子（テナント名、設定、ロゴ/テーマ参照）。
- **User**: 指令員/管理者/隊員などの役割情報（表示名、所属署、権限）。
- **Station**: 消防署の位置と所属車両の集合。
- **Unit (Vehicle)**: 車両ID、現在ステータス（Available/Assigned/En Route/On Scene/Contained）、現在位置（緯度経度）、所属基地。
- **Incident**: 通報イベント（発生場所、種別、重要度、作成者、割当られたUnits、タイムライン）。
- **DispatchEvent**: 指令の履歴（発行者、受信時刻、応答/ステータス変更）。
- **GPSPing**: 定期的な位置情報送信（タイムスタンプ、緯度経度、精度）。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 指令員が通報を作成し車両を指令する一連操作を3分以内に完了できること（典型的なユーザーテストでの測定）。
- **SC-002**: 指令発行からモバイル側で指令受信通知が届くまでの時間が平均30秒以内であること（負荷試験で測定）。
- **SC-003**: 司令室の地図上での車両位置更新は通常のネットワーク下で5秒以内に反映されること。
- **SC-004**: 指令のデータ整合性を保ち、指令トランザクションの成功率が99%を超えること（テストスイートによる検証）。
- **SC-005**: MVPリリース時点でP1シナリオ（通報→指令→出動→現着→鎮火）が手動テストで成功率95%以上で完了すること。

## Assumptions

- 本仕様はMVPフォーカスであり、高度な在庫管理、人事連携、AI予測等は対象外（overall.mdのOut-of-Scopeに準拠）。
- マルチテナントは単一スキーマ + Row-level Security (RLS) を採用する。テナントIDは JWT クレーム `tenant_id` で伝播され、アプリは JWT を検証した上でトランザクション開始時に DB セッションへ設定すること。API リクエストボディの `tenant_id` は受け付けない（存在した場合は JWT と一致しなければ 403 を返す）。将来的に必要に応じてスキーマ分離へ移行可能とする。
- プッシュ通知やジオコーディングの外部サービスは評価・選定フェーズで決定するが、MVPでは一般的な無料/OSS手段で代替できる設計とする。

### Middleware / Operational note

- 推奨: アプリは JWT 内の `tenant_id` クレームを使用してテナントを識別する。受信した JWT は発行者(issuer)、オーディエンス(audience)、有効期限を検証した上で利用すること。
- 各リクエスト/トランザクション開始時にアプリは DB 側でセッション変数を設定すること（例）:

```sql
-- トランザクション開始後に呼ぶ例
SELECT fms_set_current_tenant('00000000-0000-0000-0000-000000000000');
-- または
SET LOCAL fms.current_tenant = '00000000-0000-0000-0000-000000000000';
```

- 理由: アプリがテナント検証を行い、DB で RLS が有効な状況下でセッション単位にテナントを設定することで、クエリレベルの分離が確実になる。

- 注意: 直接ヘッダやクエリパラメータを信頼せず、常に JWT の署名とクレーム検証を行うこと。

## Dependencies

- ユーザー認証・権限管理（管理者/指令員/隊員のロール）
- 地理空間検索（住所→座標変換と近傍検索）
- リアルタイム通信基盤（双方向更新）

## Notes

- 詳細なパフォーマンス目標やSLAはフェーズ2以降に調整する。
